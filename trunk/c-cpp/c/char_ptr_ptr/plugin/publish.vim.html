<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
<title>plugin/publish.vim</title>
<meta name="Generator" content="Vim/7.2">
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<style type="text/css">
<!--
.Folded { color: #00008b; background-color: #d3d3d3; }
.Normal { background-color: #cfe8cc; }
.Special { color: #6a5acd; }
.PreProc { color: #a020f0; }
.Statement { color: #a52a2a; font-weight: bold; }
.Identifier { color: #008b8b; }
.Constant { color: #ff00ff; }
.Comment { color: #0000ff; }
pre { font-family: monospace; color: #000000; background-color: #cfe8cc; }
body { font-family: monospace; color: #000000; background-color: #cfe8cc; }
.lnr { color: #a52a2a; }

html, body, pre { margin: 0; padding: 0; }
a:link, a:visited { color: inherit; text-decoration: none; }
pre:hover a:link, pre:hover a:visited { text-decoration: underline; }
a:link span, a:visited span { text-decoration: inherit; }
.lnr a:link, .lnr a:visited { text-decoration: none !important; }
-->
</style>
</head>
<body>
<pre>
<span class="lnr"><a name="l1" href="#l1">  1 </a></span><span class="Comment">&quot; Vim plug-in</span>
<span class="lnr"><a name="l2" href="#l2">  2 </a></span><span class="Comment">&quot;</span> <span class="PreProc">Maintainer:</span><span class="Comment"> Peter Odding &lt;peter@peterodding.com&gt;</span>
<span class="lnr"><a name="l3" href="#l3">  3 </a></span><span class="Comment">&quot;</span> <span class="PreProc">Last Change:</span><span class="Comment"> June 16, 2010</span>
<span class="lnr"><a name="l4" href="#l4">  4 </a></span><span class="Comment">&quot;</span> <span class="PreProc">URL:</span><span class="Comment"> <a href="http://peterodding.com/code/vim/publish">http://peterodding.com/code/vim/publish</a></span>
<span class="lnr"><a name="l5" href="#l5">  5 </a></span><span class="Comment">&quot;</span> <span class="PreProc">License:</span><span class="Comment"> MIT</span>
<span class="lnr"><a name="l6" href="#l6">  6 </a></span><span class="Comment">&quot;</span> <span class="PreProc">Version:</span><span class="Comment"> 1.6</span>
<span class="lnr"><a name="l7" href="#l7">  7 </a></span>
<span class="lnr"><a name="l8" href="#l8">  8 </a></span><span class="Comment">&quot; Support for automatic update using the GLVS plug-in.</span>
<span class="lnr"><a name="l9" href="#l9">  9 </a></span><span class="Comment">&quot;</span> <span class="PreProc">GetLatestVimScripts:</span><span class="Comment"> 2252 1 :AutoInstall: publish.zip</span>
<span class="lnr"><a name="l10" href="#l10"> 10 </a></span>
<span class="lnr"><a name="l11" href="#l11"> 11 </a></span><span class="Comment">&quot; Don't source the plug-in when its already been loaded or &amp;compatible is set.</span>
<span class="lnr"><a name="l12" href="#l12"> 12 </a></span><span class="Statement">if</span> &amp;<span class="Statement">cp</span> <span class="Statement">||</span> <span class="Identifier">exists</span><span class="Statement">(</span><span class="Constant">'g:loaded_publish'</span><span class="Statement">)</span>
<span class="lnr"><a name="l13" href="#l13"> 13 </a></span>  <span class="Statement">finish</span>
<span class="lnr"><a name="l14" href="#l14"> 14 </a></span><span class="Statement">endif</span>
<span class="lnr"><a name="l15" href="#l15"> 15 </a></span>
<span class="lnr"><a name="l16" href="#l16"> 16 </a></span><span class="Statement">if</span> !<span class="Identifier">exists</span><span class="Statement">(</span><span class="Constant">'g:publish_omit_dothtml'</span><span class="Statement">)</span>
<span class="lnr"><a name="l17" href="#l17"> 17 </a></span>  <span class="Statement">let</span> g:publish_omit_dothtml <span class="Statement">=</span> <span class="Constant">0</span>
<span class="lnr"><a name="l18" href="#l18"> 18 </a></span><span class="Statement">endif</span>
<span class="lnr"><a name="l19" href="#l19"> 19 </a></span>
<span class="lnr"><a name="l20" href="#l20"> 20 </a></span><span class="Statement">if</span> !<span class="Identifier">exists</span><span class="Statement">(</span><span class="Constant">'g:publish_plaintext'</span><span class="Statement">)</span>
<span class="lnr"><a name="l21" href="#l21"> 21 </a></span>  <span class="Statement">let</span> g:publish_plaintext <span class="Statement">=</span> <span class="Constant">0</span>
<span class="lnr"><a name="l22" href="#l22"> 22 </a></span><span class="Statement">endif</span>
<span class="lnr"><a name="l23" href="#l23"> 23 </a></span>
<span class="lnr"><a name="l24" href="#l24"> 24 </a></span><span class="Statement">if</span> !<span class="Identifier">exists</span><span class="Statement">(</span><span class="Constant">'g:publish_viml_sl_hack'</span><span class="Statement">)</span>
<span class="lnr"><a name="l25" href="#l25"> 25 </a></span>  <span class="Statement">let</span> g:publish_viml_sl_hack <span class="Statement">=</span> <span class="Constant">1</span>
<span class="lnr"><a name="l26" href="#l26"> 26 </a></span><span class="Statement">endif</span>
<span class="lnr"><a name="l27" href="#l27"> 27 </a></span>
<span class="lnr"><a name="l28" href="#l28"> 28 </a></span><span class="Statement">function</span>! Publish<span class="Statement">(</span>source, target, files<span class="Statement">)</span> abort
<span class="lnr"><a name="l29" href="#l29"> 29 </a></span>  <span class="Statement">let</span> start <span class="Statement">=</span> xolox#timer#<span class="Normal">start</span><span class="Statement">()</span>
<span class="lnr"><a name="l30" href="#l30"> 30 </a></span>  <span class="Statement">call</span> xolox#<span class="Normal">message</span><span class="Statement">(</span><span class="Constant">&quot;Preparing to publish file%s ..&quot;</span>, len<span class="Statement">(</span>a:files<span class="Statement">)</span> <span class="Statement">==</span> <span class="Constant">1</span> ? <span class="Constant">''</span> : <span class="Constant">'s'</span><span class="Statement">)</span>
<span class="lnr"><a name="l31" href="#l31"> 31 </a></span>  <span class="Statement">let</span> s:files_to_publish <span class="Statement">=</span> publish#<span class="Normal">resolve_files</span><span class="Statement">(</span>a:source, a:files<span class="Statement">)</span>
<span class="lnr"><a name="l32" href="#l32"> 32 </a></span>  <span class="Statement">let</span> s:tags_to_publish <span class="Statement">=</span> publish#<span class="Normal">find_tags</span><span class="Statement">(</span>s:files_to_publish<span class="Statement">)</span>
<span class="lnr"><a name="l33" href="#l33"> 33 </a></span>  <span class="Statement">if</span> s:tags_to_publish <span class="Statement">!=</span> <span class="Special">{}</span>
<span class="lnr"><a name="l34" href="#l34"> 34 </a></span>    <span class="Statement">let</span> tags_to_links_command <span class="Statement">=</span> publish#<span class="Normal">create_subst_cmd</span><span class="Statement">(</span>s:tags_to_publish<span class="Statement">)</span>
<span class="lnr"><a name="l35" href="#l35"> 35 </a></span>  <span class="Statement">endif</span>
<span class="lnr"><a name="l36" href="#l36"> 36 </a></span>  <span class="Statement">let</span> rsync_target <span class="Statement">=</span> publish#<span class="Normal">rsync_check</span><span class="Statement">(</span>a:target<span class="Statement">)</span>
<span class="lnr"><a name="l37" href="#l37"> 37 </a></span>  <span class="Statement">if</span> rsync_target <span class="Statement">!=</span> <span class="Constant">''</span>
<span class="lnr"><a name="l38" href="#l38"> 38 </a></span>    <span class="Statement">let</span> rsync_dir <span class="Statement">=</span> xolox#path#<span class="Normal">tempdir</span><span class="Statement">()</span>
<span class="lnr"><a name="l39" href="#l39"> 39 </a></span>  <span class="Statement">endif</span>
<span class="lnr"><a name="l40" href="#l40"> 40 </a></span>  <span class="Statement">let</span> target_dir <span class="Statement">=</span> rsync_target <span class="Statement">!=</span> <span class="Constant">''</span> ? rsync_dir : <span class="Identifier">a:target</span>
<span class="lnr"><a name="l41" href="#l41"> 41 </a></span>  <span class="Statement">call</span> publish#<span class="Normal">prep_env</span><span class="Statement">(</span><span class="Constant">1</span><span class="Statement">)</span>
<span class="lnr"><a name="l42" href="#l42"> 42 </a></span>  <span class="Statement">for</span> pathname <span class="Statement">in</span> <span class="Identifier">a:files</span>
<span class="lnr"><a name="l43" href="#l43"> 43 </a></span>    <span class="Statement">let</span> source_path <span class="Statement">=</span> xolox#path#<span class="Normal">merge</span><span class="Statement">(</span>a:source, pathname<span class="Statement">)</span>
<span class="lnr"><a name="l44" href="#l44"> 44 </a></span>    <span class="Statement">let</span> suffix <span class="Statement">=</span> g:publish_omit_dothtml ? <span class="Constant">''</span> : <span class="Constant">'.html'</span>
<span class="lnr"><a name="l45" href="#l45"> 45 </a></span>    <span class="Statement">let</span> target_path <span class="Statement">=</span> xolox#path#<span class="Normal">merge</span><span class="Statement">(</span>target_dir, pathname <span class="Statement">.</span> suffix<span class="Statement">)</span>
<span class="lnr"><a name="l46" href="#l46"> 46 </a></span>    <span class="Statement">call</span> xolox#<span class="Normal">message</span><span class="Statement">(</span><span class="Constant">&quot;Publishing %s&quot;</span>, string<span class="Statement">(</span>pathname<span class="Statement">))</span>
<span class="lnr"><a name="l47" href="#l47"> 47 </a></span>    <span class="Statement">if</span> !publish#<span class="Normal">create_dirs</span><span class="Statement">(</span>target_path<span class="Statement">)</span>
<span class="lnr"><a name="l48" href="#l48"> 48 </a></span>      <span class="Statement">return</span>
<span class="lnr"><a name="l49" href="#l49"> 49 </a></span>    <span class="Statement">endif</span>
<span class="lnr"><a name="l50" href="#l50"> 50 </a></span><span class="Comment">    &quot; Save the pathname of the directory containing the source file in a</span>
<span class="lnr"><a name="l51" href="#l51"> 51 </a></span><span class="Comment">    &quot; script-local variable so that s:ConvertTagToLink() has access to it.</span>
<span class="lnr"><a name="l52" href="#l52"> 52 </a></span>    <span class="Statement">let</span> given_source <span class="Statement">=</span> <span class="Normal">s:FindOriginalPath</span><span class="Statement">(</span>source_path<span class="Statement">)</span>
<span class="lnr"><a name="l53" href="#l53"> 53 </a></span>    <span class="Statement">let</span> s:current_source_directory <span class="Statement">=</span> <span class="Identifier">fnamemodify</span><span class="Statement">(</span>given_source, <span class="Constant">':h'</span><span class="Statement">)</span>
<span class="lnr"><a name="l54" href="#l54"> 54 </a></span>    <span class="Statement">silent</span> <span class="Statement">execute</span> <span class="Constant">'edit!'</span> fnameescape<span class="Statement">(</span>source_path<span class="Statement">)</span>
<span class="lnr"><a name="l55" href="#l55"> 55 </a></span>    <span class="Statement">if</span> g:publish_plaintext
<span class="lnr"><a name="l56" href="#l56"> 56 </a></span>      <span class="Statement">let</span> plaintext_path <span class="Statement">=</span> xolox#path#<span class="Normal">merge</span><span class="Statement">(</span>target_dir, pathname <span class="Statement">.</span> <span class="Constant">'.txt'</span><span class="Statement">)</span>
<span class="lnr"><a name="l57" href="#l57"> 57 </a></span>      <span class="Statement">silent</span> <span class="Statement">execute</span> <span class="Constant">'write!'</span> fnameescape<span class="Statement">(</span>plaintext_path<span class="Statement">)</span>
<span class="lnr"><a name="l58" href="#l58"> 58 </a></span>    <span class="Statement">endif</span>
<span class="lnr"><a name="l59" href="#l59"> 59 </a></span>    <span class="Statement">silent</span> <span class="Statement">execute</span> <span class="Constant">'doautocmd User PublishPre'</span>
<span class="lnr"><a name="l60" href="#l60"> 60 </a></span>    <span class="Statement">runtime</span> syntax/<span class="Constant">2</span>html<span class="Statement">.</span><span class="Statement">vim</span>
<span class="lnr"><a name="l61" href="#l61"> 61 </a></span>    <span class="Statement">if</span> <span class="Identifier">exists</span><span class="Statement">(</span><span class="Constant">'tags_to_links_command'</span><span class="Statement">)</span>
<span class="lnr"><a name="l62" href="#l62"> 62 </a></span>      <span class="Statement">silent</span> <span class="Statement">execute</span> tags_to_links_command
<span class="lnr"><a name="l63" href="#l63"> 63 </a></span>    <span class="Statement">endif</span>
<span class="lnr"><a name="l64" href="#l64"> 64 </a></span>    <span class="Statement">call</span> publish#<span class="Normal">customize_html</span><span class="Statement">(</span>pathname<span class="Statement">)</span>
<span class="lnr"><a name="l65" href="#l65"> 65 </a></span>    <span class="Statement">silent</span> <span class="Statement">execute</span> <span class="Constant">'write!'</span> fnameescape<span class="Statement">(</span>target_path<span class="Statement">)</span>
<span class="lnr"><a name="l66" href="#l66"> 66 </a></span>    <span class="Statement">bwipeout</span>!
<span class="lnr"><a name="l67" href="#l67"> 67 </a></span>  <span class="Statement">endfor</span>
<span class="lnr"><a name="l68" href="#l68"> 68 </a></span>  <span class="Statement">call</span> publish#<span class="Normal">prep_env</span><span class="Statement">(</span><span class="Constant">0</span><span class="Statement">)</span>
<span class="lnr"><a name="l69" href="#l69"> 69 </a></span>  <span class="Statement">unlet</span> s:files_to_publish s:tags_to_publish
<span class="lnr"><a name="l70" href="#l70"> 70 </a></span>  <span class="Statement">if</span> rsync_target <span class="Statement">!=</span> <span class="Constant">''</span>
<span class="lnr"><a name="l71" href="#l71"> 71 </a></span>    <span class="Statement">call</span> publish#<span class="Normal">run_rsync</span><span class="Statement">(</span>rsync_target, rsync_dir<span class="Statement">)</span>
<span class="lnr"><a name="l72" href="#l72"> 72 </a></span>  <span class="Statement">endif</span>
<span class="lnr"><a name="l73" href="#l73"> 73 </a></span>  <span class="Statement">let</span> msg <span class="Statement">=</span> <span class="Constant">&quot;publish.vim: Published %i file%s to %s.&quot;</span>
<span class="lnr"><a name="l74" href="#l74"> 74 </a></span>  <span class="Statement">call</span> xolox#<span class="Normal">message</span><span class="Statement">(</span>msg, len<span class="Statement">(</span>a:files<span class="Statement">)</span>, len<span class="Statement">(</span>a:files<span class="Statement">)</span> <span class="Statement">==</span> <span class="Constant">1</span> ? <span class="Constant">''</span> : <span class="Constant">'s'</span>, a:target<span class="Statement">)</span>
<span class="lnr"><a name="l75" href="#l75"> 75 </a></span>  <span class="Statement">call</span> xolox#timer#<span class="Normal">stop</span><span class="Statement">(</span><span class="Constant">&quot;Finished publishing files in %s.&quot;</span>, start<span class="Statement">)</span>
<span class="lnr"><a name="l76" href="#l76"> 76 </a></span><span class="Statement">endfunction</span>
<span class="lnr"><a name="l77" href="#l77"> 77 </a></span>
<span class="Folded"> 78 +--  5 lines: function! s:FindOriginalPath(pathname) -------------------------------------------</span>
<span class="Folded"> 83 +-- 28 lines: function! s:ConvertTagToLink(name) -----------------------------------------------</span>
</pre>
</body>
</html>
